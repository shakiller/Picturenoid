<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Breaker - –ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            background: #16213e;
            padding: 10px 15px;
            border-bottom: 2px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .logo {
            font-size: 18px;
            font-weight: bold;
            color: #e94560;
        }

        .file-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            background: #ff6b81;
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #0f3460;
        }

        .btn-secondary:active {
            background: #1a4a7a;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
        .main-area {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .tool-panel {
            width: 70px;
            background: #16213e;
            border-right: 2px solid #0f3460;
            display: flex;
            flex-direction: column;
            padding: 10px 5px;
            gap: 8px;
        }

        .tool {
            width: 60px;
            height: 60px;
            background: #1a1a2e;
            border: 2px solid #e94560;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s;
        }

        .tool.active {
            background: #e94560;
            transform: scale(1.05);
        }

        .tool:active {
            transform: scale(0.95);
        }

        /* –û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .canvas-container {
            flex: 1;
            position: relative;
            background: #2d2d44;
            overflow: hidden;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        #referenceImage {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0.7;
            max-width: 100%;
            max-height: 100%;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ */
        .properties-panel {
            background: #16213e;
            padding: 15px;
            border-top: 2px solid #0f3460;
            min-height: 120px;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .property-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .property-label {
            font-size: 12px;
            color: #e94560;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .color {
            width: 30px;
            height: 30px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
        }

        .color.active {
            border-color: white;
            transform: scale(1.1);
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #0f3460;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #e94560;
            background: #1a1a2e;
            color: white;
            font-size: 14px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 2px solid #e94560;
        }

        .modal-title {
            font-size: 18px;
            color: #e94560;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        .status-bar {
            background: #0f3460;
            padding: 8px 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .tool-panel {
                width: 60px;
            }
            
            .tool {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .properties-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .top-bar {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
            }
            
            .tool-panel {
                width: 50px;
                padding: 5px;
            }
            
            .tool {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è touch */
        .touch-feedback:active {
            opacity: 0.7;
        }

        /* Scrollable areas */
        .scrollable {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div class="top-bar">
            <div class="logo">Vector Breaker</div>
            <div class="file-controls">
                <button class="btn btn-secondary" id="loadImageBtn">
                    üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
                <button class="btn" id="saveBtn">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-secondary" id="menuBtn">
                    ‚ãÆ –ú–µ–Ω—é
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-area">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="tool-panel">
                <div class="tool active" data-tool="pen" title="–ü–µ—Ä–æ">‚úèÔ∏è</div>
                <div class="tool" data-tool="select" title="–í—ã–¥–µ–ª–µ–Ω–∏–µ">‚Üñ</div>
                <div class="tool" data-tool="rectangle" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫">‚ñ°</div>
                <div class="tool" data-tool="circle" title="–ö—Ä—É–≥">‚óã</div>
                <div class="tool" data-tool="line" title="–õ–∏–Ω–∏—è">üìè</div>
                <div class="tool" data-tool="erase" title="–õ–∞—Å—Ç–∏–∫">üßπ</div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
            <div class="canvas-container">
                <img id="referenceImage" style="display: none;">
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ -->
        <div class="properties-panel">
            <div class="properties-grid">
                <div class="property-group">
                    <div class="property-label">–¶–≤–µ—Ç</div>
                    <div class="color-palette">
                        <div class="color active" style="background: #ff0000;" data-color="#ff0000"></div>
                        <div class="color" style="background: #00ff00;" data-color="#00ff00"></div>
                        <div class="color" style="background: #0000ff;" data-color="#0000ff"></div>
                        <div class="color" style="background: #ffff00;" data-color="#ffff00"></div>
                        <div class="color" style="background: #ff00ff;" data-color="#ff00ff"></div>
                        <div class="color" style="background: #00ffff;" data-color="#00ffff"></div>
                        <div class="color" style="background: #ffffff;" data-color="#ffffff"></div>
                        <div class="color" style="background: #000000;" data-color="#000000"></div>
                    </div>
                </div>

                <div class="property-group">
                    <div class="property-label">–¢–æ–ª—â–∏–Ω–∞: <span id="widthValue">2</span></div>
                    <input type="range" class="slider" id="strokeWidth" min="1" max="10" value="2">
                </div>

                <div class="property-group">
                    <div class="property-label">–ü—Ä–æ—á–Ω–æ—Å—Ç—å: <span id="healthValue">1</span></div>
                    <input type="range" class="slider" id="blockHealth" min="1" max="3" value="1">
                </div>

                <div class="property-group">
                    <div class="property-label">–≠—Ñ—Ñ–µ–∫—Ç</div>
                    <select id="blockEffect">
                        <option value="none">–ù–µ—Ç</option>
                        <option value="multiball">–ú—É–ª—å—Ç–∏–º—è—á</option>
                        <option value="expand">–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ</option>
                        <option value="fireball">–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä</option>
                    </select>
                </div>

                <div class="property-group">
                    <div class="property-label">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacityValue">70%</span></div>
                    <input type="range" class="slider" id="imageOpacity" min="0" max="100" value="70">
                </div>

                <div class="property-group">
                    <div class="property-label">–†–µ–∂–∏–º</div>
                    <select id="displayMode">
                        <option value="both">–ò–∑–æ–±—Ä + –í–µ–∫—Ç–æ—Ä</option>
                        <option value="vector">–¢–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä</option>
                        <option value="image">–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div class="status-bar">
            <span id="cursorPos">X: 0, Y: 0</span>
            <span id="toolInfo">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –ü–µ—Ä–æ</span>
            <span>–ú–∞—Å—à—Ç–∞–±: <span id="zoomLevel">100%</span></span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
    <div class="modal" id="loadImageModal">
        <div class="modal-content">
            <div class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            <p style="margin-bottom: 15px; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏</p>
            
            <input type="file" id="imageInput" class="file-input" accept="image/*">
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="document.getElementById('imageInput').click()">
                    üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </button>
                <button class="btn" id="confirmLoadBtn">
                    ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
                <button class="btn btn-secondary" id="cancelLoadBtn">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-title">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è:</label>
                <input type="text" id="levelName" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #e94560; background: #1a1a2e; color: white;" value="–ú–æ–π —É—Ä–æ–≤–µ–Ω—å">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">–ê–≤—Ç–æ—Ä:</label>
                <input type="text" id="authorName" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #e94560; background: #1a1a2e; color: white;" value="–ê–Ω–æ–Ω–∏–º">
            </div>
            
            <div class="modal-buttons">
                <button class="btn" id="saveProjectBtn">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
                <button class="btn btn-secondary" id="exportGameBtn">
                    üéÆ –≠–∫—Å–ø–æ—Ä—Ç –≤ –∏–≥—Ä—É
                </button>
                <button class="btn btn-secondary" id="cancelSaveBtn">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ–Ω—é -->
    <div class="modal" id="menuModal">
        <div class="modal-content">
            <div class="modal-title">–ú–µ–Ω—é</div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn" id="newProjectBtn">
                    üÜï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </button>
                <button class="btn btn-secondary" id="loadProjectBtn">
                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
                <button class="btn btn-secondary" id="clearCanvasBtn">
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
                </button>
                <button class="btn btn-secondary" id="settingsBtn">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="btn btn-secondary" id="closeMenuBtn">
                    ‚ùå –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        class MobileVectorEditor {
            constructor() {
                this.canvas = document.getElementById('drawingCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.referenceImage = document.getElementById('referenceImage');
                
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                this.currentTool = 'pen';
                this.currentColor = '#ff0000';
                this.strokeWidth = 2;
                this.blockHealth = 1;
                this.blockEffect = 'none';
                this.imageOpacity = 0.7;
                this.displayMode = 'both';
                
                // –í–µ–∫—Ç–æ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.shapes = [];
                this.currentPath = null;
                this.selectedShape = null;
                
                // –ò—Å—Ç–æ—Ä–∏—è
                this.history = [];
                this.historyIndex = -1;
                
                // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                this.scale = 1;
                this.offsetX = 0;
                this.offsetY = 0;
                this.lastTouch = null;
                
                this.init();
            }
            
            init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.setupModals();
                this.render();
            }
            
            setupCanvas() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –∫–∞–∫ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }
            
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.render();
            }
            
            setupEventListeners() {
                // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
                document.querySelectorAll('.tool').forEach(tool => {
                    tool.addEventListener('click', (e) => {
                        document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentTool = e.currentTarget.dataset.tool;
                        this.updateToolInfo();
                    });
                });
                
                // –¶–≤–µ—Ç–∞
                document.querySelectorAll('.color').forEach(color => {
                    color.addEventListener('click', (e) => {
                        document.querySelectorAll('.color').forEach(c => c.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentColor = e.currentTarget.dataset.color;
                    });
                });
                
                // –°–ª–∞–π–¥–µ—Ä—ã
                document.getElementById('strokeWidth').addEventListener('input', (e) => {
                    this.strokeWidth = parseInt(e.target.value);
                    document.getElementById('widthValue').textContent = this.strokeWidth;
                });
                
                document.getElementById('blockHealth').addEventListener('input', (e) => {
                    this.blockHealth = parseInt(e.target.value);
                    document.getElementById('healthValue').textContent = this.blockHealth;
                });
                
                document.getElementById('imageOpacity').addEventListener('input', (e) => {
                    this.imageOpacity = e.target.value / 100;
                    document.getElementById('opacityValue').textContent = e.target.value + '%';
                    this.referenceImage.style.opacity = this.imageOpacity;
                });
                
                document.getElementById('blockEffect').addEventListener('change', (e) => {
                    this.blockEffect = e.target.value;
                });
                
                document.getElementById('displayMode').addEventListener('change', (e) => {
                    this.displayMode = e.target.value;
                    this.updateDisplayMode();
                });
                
                // –°–æ–±—ã—Ç–∏—è –∫–∞—Å–∞–Ω–∏—è –¥–ª—è canvas
                this.canvas.addEventListener('touchstart', (e) => this.onTouchStart(e));
                this.canvas.addEventListener('touchmove', (e) => this.onTouchMove(e));
                this.canvas.addEventListener('touchend', (e) => this.onTouchEnd(e));
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
                this.canvas.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const pos = this.getTouchPos(touch);
                    document.getElementById('cursorPos').textContent = `X: ${Math.round(pos.x)}, Y: ${Math.round(pos.y)}`;
                });
            }
            
            setupModals() {
                // –ö–Ω–æ–ø–∫–∏ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏
                document.getElementById('loadImageBtn').addEventListener('click', () => {
                    this.showModal('loadImageModal');
                });
                
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.showModal('saveModal');
                });
                
                document.getElementById('menuBtn').addEventListener('click', () => {
                    this.showModal('menuModal');
                });
                
                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                document.getElementById('imageInput').addEventListener('change', (e) => this.handleImageSelect(e));
                document.getElementById('confirmLoadBtn').addEventListener('click', () => this.loadSelectedImage());
                document.getElementById('cancelLoadBtn').addEventListener('click', () => this.hideModal('loadImageModal'));
                
                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                document.getElementById('saveProjectBtn').addEventListener('click', () => this.saveProject());
                document.getElementById('exportGameBtn').addEventListener('click', () => this.exportToGame());
                document.getElementById('cancelSaveBtn').addEventListener('click', () => this.hideModal('saveModal'));
                
                // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ–Ω—é
                document.getElementById('newProjectBtn').addEventListener('click', () => this.newProject());
                document.getElementById('loadProjectBtn').addEventListener('click', () => this.loadProject());
                document.getElementById('clearCanvasBtn').addEventListener('click', () => this.clearCanvas());
                document.getElementById('closeMenuBtn').addEventListener('click', () => this.hideModal('menuModal'));
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal(modal.id);
                        }
                    });
                });
            }
            
            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }
            
            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
            
            getTouchPos(touch) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: (touch.clientX - rect.left - this.offsetX) / this.scale,
                    y: (touch.clientY - rect.top - this.offsetY) / this.scale
                };
            }
            
            onTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const pos = this.getTouchPos(touch);
                this.lastTouch = { x: touch.clientX, y: touch.clientY };
                
                switch (this.currentTool) {
                    case 'pen':
                        this.startNewPath(pos);
                        break;
                    case 'rectangle':
                    case 'circle':
                    case 'line':
                        this.startPrimitiveShape(pos);
                        break;
                }
                
                this.render();
            }
            
            onTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const pos = this.getTouchPos(touch);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è/–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏
                if (e.touches.length === 2) {
                    this.handlePinchZoom(e);
                    return;
                }
                
                switch (this.currentTool) {
                    case 'pen':
                        this.addPointToCurrentPath(pos);
                        break;
                    case 'rectangle':
                    case 'circle':
                    case 'line':
                        this.updatePrimitiveShape(pos);
                        break;
                }
                
                this.lastTouch = { x: touch.clientX, y: touch.clientY };
                this.render();
            }
            
            onTouchEnd(e) {
                switch (this.currentTool) {
                    case 'pen':
                        this.finalizePath();
                        break;
                    case 'rectangle':
                    case 'circle':
                    case 'line':
                        this.finalizePrimitiveShape();
                        break;
                }
                
                this.saveToHistory();
                this.lastTouch = null;
            }
            
            handlePinchZoom(e) {
                if (e.touches.length !== 2) return;
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                
                const currentDistance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                
                if (this.lastPinchDistance) {
                    const scaleFactor = currentDistance / this.lastPinchDistance;
                    this.zoom(scaleFactor, (touch1.clientX + touch2.clientX) / 2, (touch1.clientY + touch2.clientY) / 2);
                }
                
                this.lastPinchDistance = currentDistance;
            }
            
            zoom(factor, x, y) {
                const oldScale = this.scale;
                this.scale *= factor;
                this.scale = Math.max(0.1, Math.min(5, this.scale));
                
                const rect = this.canvas.getBoundingClientRect();
                const worldX = (x - rect.left - this.offsetX) / oldScale;
                const worldY = (y - rect.top - this.offsetY) / oldScale;
                
                this.offsetX = x - rect.left - worldX * this.scale;
                this.offsetY = y - rect.top - worldY * this.scale;
                
                document.getElementById('zoomLevel').textContent = Math.round(this.scale * 100) + '%';
                this.render();
            }
            
            // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏
            startNewPath(pos) {
                this.currentPath = {
                    type: 'path',
                    points: [this.snapPoint(pos)],
                    color: this.currentColor,
                    strokeWidth: this.strokeWidth,
                    health: this.blockHealth,
                    effect: this.blockEffect
                };
            }
            
            addPointToCurrentPath(pos) {
                if (this.currentPath) {
                    const snappedPos = this.snapPoint(pos);
                    const lastPoint = this.currentPath.points[this.currentPath.points.length - 1];
                    const distance = Math.sqrt(Math.pow(snappedPos.x - lastPoint.x, 2) + Math.pow(snappedPos.y - lastPoint.y, 2));
                    
                    if (distance > 3) {
                        this.currentPath.points.push(snappedPos);
                    }
                }
            }
            
            finalizePath() {
                if (this.currentPath && this.currentPath.points.length > 1) {
                    this.shapes.push(this.currentPath);
                    this.currentPath = null;
                }
            }
            
            // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–≥—É—Ä
            startPrimitiveShape(pos) {
                this.currentPath = {
                    type: this.currentTool,
                    x: pos.x,
                    y: pos.y,
                    width: 0,
                    height: 0,
                    color: this.currentColor,
                    strokeWidth: this.strokeWidth,
                    health: this.blockHealth,
                    effect: this.blockEffect
                };
                
                if (this.currentTool === 'circle') {
                    this.currentPath.radius = 0;
                }
            }
            
            updatePrimitiveShape(pos) {
                if (this.currentPath) {
                    if (this.currentTool === 'rectangle') {
                        this.currentPath.width = pos.x - this.currentPath.x;
                        this.currentPath.height = pos.y - this.currentPath.y;
                    } else if (this.currentTool === 'circle') {
                        this.currentPath.radius = Math.sqrt(
                            Math.pow(pos.x - this.currentPath.x, 2) + 
                            Math.pow(pos.y - this.currentPath.y, 2)
                        );
                    } else if (this.currentTool === 'line') {
                        this.currentPath.width = pos.x - this.currentPath.x;
                        this.currentPath.height = pos.y - this.currentPath.y;
                    }
                }
            }
            
            finalizePrimitiveShape() {
                if (this.currentPath) {
                    const hasSize = this.currentTool === 'rectangle' ? 
                        Math.abs(this.currentPath.width) > 5 && Math.abs(this.currentPath.height) > 5 :
                        this.currentTool === 'circle' ? this.currentPath.radius > 5 :
                        Math.abs(this.currentPath.width) > 5 || Math.abs(this.currentPath.height) > 5;
                    
                    if (hasSize) {
                        this.shapes.push(this.currentPath);
                    }
                    this.currentPath = null;
                }
            }
            
            snapPoint(pos) {
                const gridSize = 10;
                return {
                    x: Math.round(pos.x / gridSize) * gridSize,
                    y: Math.round(pos.y / gridSize) * gridSize
                };
            }
            
            render() {
                this.ctx.save();
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.restore();
                
                this.ctx.save();
                this.ctx.translate(this.offsetX, this.offsetY);
                this.ctx.scale(this.scale, this.scale);
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–≥—É—Ä—ã
                this.shapes.forEach(shape => {
                    this.drawShape(shape);
                });
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å
                if (this.currentPath) {
                    this.drawShape(this.currentPath);
                }
                
                this.ctx.restore();
            }
            
            drawShape(shape) {
                this.ctx.strokeStyle = shape.color;
                this.ctx.fillStyle = shape.color;
                this.ctx.lineWidth = shape.strokeWidth;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                switch (shape.type) {
                    case 'path':
                        this.ctx.beginPath();
                        this.ctx.moveTo(shape.points[0].x, shape.points[0].y);
                        
                        for (let i = 1; i < shape.points.length; i++) {
                            this.ctx.lineTo(shape.points[i].x, shape.points[i].y);
                        }
                        
                        this.ctx.stroke();
                        break;
                        
                    case 'rectangle':
                        this.ctx.strokeRect(shape.x, shape.y, shape.width, shape.height);
                        break;
                        
                    case 'circle':
                        this.ctx.beginPath();
                        this.ctx.arc(shape.x, shape.y, shape.radius, 0, 2 * Math.PI);
                        this.ctx.stroke();
                        break;
                        
                    case 'line':
                        this.ctx.beginPath();
                        this.ctx.moveTo(shape.x, shape.y);
                        this.ctx.lineTo(shape.x + shape.width, shape.y + shape.height);
                        this.ctx.stroke();
                        break;
                }
            }
            
            updateToolInfo() {
                const toolNames = {
                    'pen': '–ü–µ—Ä–æ',
                    'select': '–í—ã–¥–µ–ª–µ–Ω–∏–µ',
                    'rectangle': '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫',
                    'circle': '–ö—Ä—É–≥',
                    'line': '–õ–∏–Ω–∏—è',
                    'erase': '–õ–∞—Å—Ç–∏–∫'
                };
                document.getElementById('toolInfo').textContent = `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${toolNames[this.currentTool]}`;
            }
            
            updateDisplayMode() {
                switch (this.displayMode) {
                    case 'both':
                        this.referenceImage.style.display = 'block';
                        break;
                    case 'vector':
                        this.referenceImage.style.display = 'none';
                        break;
                    case 'image':
                        this.referenceImage.style.display = 'block';
                        break;
                }
            }
            
            // –†–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            handleImageSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.selectedImageData = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            loadSelectedImage() {
                if (this.selectedImageData) {
                    this.referenceImage.src = this.selectedImageData;
                    this.referenceImage.style.display = 'block';
                    this.centerImage();
                    this.hideModal('loadImageModal');
                    this.render();
                } else {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
                }
            }
            
            centerImage() {
                if (this.referenceImage.src) {
                    const container = this.canvas.parentElement;
                    const imgAspect = this.referenceImage.naturalWidth / this.referenceImage.naturalHeight;
                    const containerAspect = container.clientWidth / container.clientHeight;
                    
                    let scale;
                    if (imgAspect > containerAspect) {
                        scale = container.clientWidth / this.referenceImage.naturalWidth;
                    } else {
                        scale = container.clientHeight / this.referenceImage.naturalHeight;
                    }
                    
                    this.referenceImage.style.width = (this.referenceImage.naturalWidth * scale) + 'px';
                    this.referenceImage.style.height = (this.referenceImage.naturalHeight * scale) + 'px';
                    this.referenceImage.style.left = ((container.clientWidth - this.referenceImage.naturalWidth * scale) / 2) + 'px';
                    this.referenceImage.style.top = ((container.clientHeight - this.referenceImage.naturalHeight * scale) / 2) + 'px';
                }
            }
            
            // –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏
            saveToHistory() {
                this.history = this.history.slice(0, this.historyIndex + 1);
                const snapshot = JSON.parse(JSON.stringify(this.shapes));
                this.history.push(snapshot);
                this.historyIndex++;
            }
            
            newProject() {
                if (confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç? –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                    this.shapes = [];
                    this.referenceImage.style.display = 'none';
                    this.scale = 1;
                    this.offsetX = 0;
                    this.offsetY = 0;
                    this.history = [];
                    this.historyIndex = -1;
                    this.render();
                    this.hideModal('menuModal');
                }
            }
            
            saveProject() {
                const levelName = document.getElementById('levelName').value || '–ú–æ–π —É—Ä–æ–≤–µ–Ω—å';
                const author = document.getElementById('authorName').value || '–ê–Ω–æ–Ω–∏–º';
                
                const project = {
                    name: levelName,
                    author: author,
                    shapes: this.shapes,
                    image: this.referenceImage.src,
                    metadata: {
                        created: new Date().toISOString(),
                        version: '1.0'
                    }
                };
                
                const data = JSON.stringify(project, null, 2);
                this.downloadFile(data, levelName + '.json', 'application/json');
                this.hideModal('saveModal');
                
                alert('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            }
            
            exportToGame() {
                const levelName = document.getElementById('levelName').value || '–ú–æ–π —É—Ä–æ–≤–µ–Ω—å';
                const author = document.getElementById('authorName').value || '–ê–Ω–æ–Ω–∏–º';
                
                const gameLevel = {
                    title: levelName,
                    author: author,
                    background: '#1a1a2e',
                    elements: this.shapes.map(shape => ({
                        ...shape,
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
                        health: shape.health || 1,
                        effect: shape.effect || 'none'
                    }))
                };
                
                const data = JSON.stringify(gameLevel, null, 2);
                this.downloadFile(data, levelName + '_game.json', 'application/json');
                this.hideModal('saveModal');
                
                alert('–£—Ä–æ–≤–µ–Ω—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏–≥—Ä—ã!');
            }
            
            loadProject() {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
                alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!');
            }
            
            clearCanvas() {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ñ–∏–≥—É—Ä—ã?')) {
                    this.saveToHistory();
                    this.shapes = [];
                    this.render();
                    this.hideModal('menuModal');
                }
            }
            
            downloadFile(data, filename, type) {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            new MobileVectorEditor();
        });
    </script>
</body>
</html>